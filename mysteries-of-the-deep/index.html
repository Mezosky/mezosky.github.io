<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mysteries of the Deep | NeurIPS 2025</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for the interactive explorer -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>

    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom animation for results appearing */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* SVG Diagram Styles */
        .svg-bg { fill: #f8fafc; }
        .svg-text-label { font-size: 14px; font-weight: 600; fill: #1e293b; }
        .svg-text-small { font-size: 12px; fill: #475569; }
        .svg-arrow-path { stroke: #94a3b8; stroke-width: 1.5px; fill: none; }
        
        /* Styles for interactive SVG layers */
        .svg-layer-group { transition: all 0.2s ease-in-out; cursor: pointer; }
        .svg-layer-box { fill: #eef2ff; stroke: #c7d2fe; stroke-width: 2px; transition: all 0.2s ease-in-out;}
        .svg-layer-text { font-weight: 500; fill: #4338ca; transition: fill 0.2s ease-in-out; }
        .svg-score-group > text { transition: all 0.2s ease-in-out; fill: #475569; }

        /* Highlight styles for selected layers */
        .svg-layer-group.highlighted .svg-layer-box { fill: #6366f1; stroke: #4f46e5; }
        .svg-layer-group.highlighted .svg-layer-text { fill: white; }
        .svg-layer-group.highlighted .svg-output-arrow { stroke: #6366f1; stroke-width: 2.5px; }
        .svg-layer-group.highlighted .svg-score-group > text { fill: #4338ca; font-weight: 600; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 sm:py-16">
        
        <!-- Header Section -->
        <header class="text-center mb-12">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 tracking-tight mb-4">
                Mysteries of the Deep: Role of Intermediate Representations in Out-of-Distribution Detection
            </h1>
            <div class="text-slate-600 mb-2">
                <a href="#" class="hover:underline">Ignacio Meza De la Jara</a><sup>1,4</sup>,
                <a href="#" class="hover:underline">Cristian Rodriguez-Opazo</a><sup>1</sup>,
                <a href="#" class="hover:underline">Damien Teney</a><sup>1,2</sup>,
                <a href="#" class="hover:underline">Damith Ranasinghe</a><sup>1</sup>,
                <a href="#" class="hover:underline">Ehsan Abbasnejad</a><sup>1,3</sup>
            </div>
            <div class="text-sm text-slate-500 mb-4">
                <sup>1</sup>Australian Institute for Machine Learning, University of Adelaide&nbsp;&nbsp;
                <sup>2</sup>Idiap Research Institute<br>
                <sup>3</sup>Monash University&nbsp;&nbsp;
                <sup>4</sup>Naval Group
            </div>
            <p class="text-lg font-semibold text-indigo-600 mb-6">NeurIPS 2025</p>
            <div class="flex justify-center items-center gap-x-6 text-base font-medium text-indigo-600">
                <a href="#" class="hover:text-indigo-800 transition-colors">Paper</a>
                <a href="#" class="hover:text-indigo-800 transition-colors">Code</a>
                <a href="#" class="hover:text-indigo-800 transition-colors">Data</a>
                <a href="#" class="hover:text-indigo-800 transition-colors">BibTeX</a>
            </div>
        </header>

        <!-- Teaser Figure (Updated) -->
        <div class="mb-16 bg-white p-4 sm:p-6 rounded-lg shadow-lg border border-slate-200">
             <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                <div class="md:col-span-3 h-96">
                    <canvas id="lineChart"></canvas>
                </div>
                <div class="md:col-span-2 h-96">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Abstract Section -->
        <section class="mb-16 max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-center mb-6 text-slate-900">Abstract</h2>
            <p class="text-slate-600 leading-relaxed text-justify">
                Out-of-distribution (OOD) detection is essential for reliably deploying machine learning models in the wild. Yet, most methods treat large pre-trained models as monolithic encoders and rely solely on their final-layer representations for detection. We challenge this wisdom. We reveal the intermediate layers of pre-trained models, shaped by residual connections that subtly transform input projections, can encode surprisingly rich and diverse signals for detecting distributional shifts. Importantly, to exploit latent representation diversity across layers, we introduce an entropy-based criterion to automatically identify layers offering the most complementary information in a training-free setting—without access to OOD data. We show that selectively incorporating these intermediate representations can increase the accuracy of OOD detection by up to 10% in far-OOD and over 7% in near-OOD benchmarks compared to state-of-the-art training-free methods across various model architectures and training objectives.
            </p>
        </section>

        <!-- Separator -->
        <hr class="border-slate-200 my-16 max-w-xl mx-auto">

        <!-- Interactive Explorer Section -->
        <section class="mb-16">
            <h2 class="text-2xl font-bold text-center mb-2 text-slate-900">Interactive Layer Explorer</h2>
            <p class="text-center text-slate-500 mb-10 max-w-2xl mx-auto">
                Experiment with different layer combinations to see how fusing intermediate representations impacts OOD detection performance.
            </p>
            
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12">
                <!-- Controls Panel -->
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md border border-slate-200 self-start">
                    <div class="mb-6">
                        <label for="architecture" class="block text-sm font-medium text-slate-700 mb-2">1. Select Architecture:</label>
                        <select id="architecture" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="clip-b16">CLIP ViT-B/16 (12 Layers)</option>
                            <option value="clip-b32">CLIP ViT-B/32 (12 Layers)</option>
                            <option value="clip-l14">CLIP ViT-L/14 (24 Layers)</option>
                            <option value="resnet">ResNet-50 (16 Layers)</option>
                        </select>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">2. Select Layers to Fuse:</label>
                        <div id="layer-checkboxes" class="grid grid-cols-4 sm:grid-cols-5 gap-2"></div>
                    </div>
                    
                    <div id="message-box" class="text-red-600 text-sm mb-4 h-5"></div>

                    <div class="flex gap-4">
                        <button id="calculate-btn" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-4 rounded-md hover:bg-indigo-700 transition-all transform hover:scale-105 shadow-sm">
                            Calculate Performance
                        </button>
                        <button id="reset-btn" class="flex-1 bg-slate-200 text-slate-700 font-semibold py-3 px-4 rounded-md hover:bg-slate-300 transition-all">
                            Reset
                        </button>
                    </div>
                </div>

                <!-- Diagram -->
                <div class="lg:col-span-3 min-h-[500px] bg-white p-4 rounded-lg shadow-md border border-slate-200">
                    <svg id="interactive-diagram" class="w-full h-auto">
                        <defs>
                            <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto" markerUnits="strokeWidth">
                                <polygon points="0 0, 8 3, 0 6" class="fill-current text-slate-400" />
                            </marker>
                        </defs>
                        <!-- This container will be populated dynamically -->
                        <g id="diagram-content-container"></g>
                    </svg>
                </div>
            </div>
            
            <!-- Results Container -->
            <div id="results-container" class="mt-8" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 text-center">
                        <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">Average FPR@95</h4>
                        <p id="fpr-value" class="text-4xl font-light text-slate-900">-</p>
                        <div id="fpr-change" class="mt-2"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 text-center">
                        <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">Average AUROC</h4>
                        <p id="auroc-value" class="text-4xl font-light text-slate-900">-</p>
                        <div id="auroc-change" class="mt-2"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 text-center">
                        <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">Selected Layers</h4>
                        <p id="layers-count" class="text-4xl font-light text-slate-900">-</p>
                        <p id="selected-layers" class="text-xs text-slate-500 mt-2 truncate">-</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">Performance by Dataset</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-slate-200">
                                <th class="p-3 text-left text-sm font-semibold text-slate-600">Dataset</th>
                                <th class="p-3 text-left text-sm font-semibold text-slate-600">FPR@95 ↓</th>
                                <th class="p-3 text-left text-sm font-semibold text-slate-600">AUROC ↑</th>
                            </tr>
                        </thead>
                        <tbody id="dataset-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Separator -->
        <hr class="border-slate-200 my-16 max-w-xl mx-auto">
        
        <!-- Citation Section -->
        <section class="max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-center mb-6 text-slate-900">Citation</h2>
            <div class="bg-slate-100 p-6 rounded-lg text-sm text-slate-600 overflow-x-auto">
                <pre><code>@inproceedings{meza2025mysteries,
  title     = {Mysteries of the Deep: Role of Intermediate Representations in Out-of-Distribution Detection},
  author    = {Meza De la Jara, Ignacio and Rodriguez-Opazo, Cristian and Teney, Damien and Ranasinghe, Damith and Abbasnejad, Ehsan},
  booktitle = {Advances in Neural Information Processing Systems},
  year      = {2025}
}</code></pre>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-slate-500 mt-16">
            <p>Questions? Contact us at firstname.lastname@adelaide.edu.au</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Teaser Charts ---
            const lineCtx = document.getElementById('lineChart').getContext('2d');
            const barCtx = document.getElementById('barChart').getContext('2d');

            const colors = {
                cliprn: 'rgba(44, 114, 142, 1)',
                clipvit: 'rgba(143, 209, 158, 1)',
                clipvitb32: 'rgba(168, 125, 194, 1)',
                vit: 'rgba(220, 157, 73, 1)',
                pe: 'rgba(241, 218, 91, 1)',
                siglip: 'rgba(209, 124, 106, 1)'
            };
            const bgColors = {
                cliprn: 'rgba(44, 114, 142, 0.2)',
                clipvit: 'rgba(143, 209, 158, 0.2)',
                clipvitb32: 'rgba(168, 125, 194, 0.2)',
                vit: 'rgba(220, 157, 73, 0.2)',
                pe: 'rgba(241, 218, 91, 0.2)',
                siglip: 'rgba(209, 124, 106, 0.2)'
            }
            
            const defaultFont = { family: 'system-ui, -apple-system, sans-serif' };

            const lineChartData = {
                labels: Array.from({length: 12}, (_, i) => i + 1),
                datasets: [
                    // CLIP RN50
                    { label: 'CLIP RN50', data: [0.4516, 0.4473, 0.4415, 0.4360], borderColor: colors.cliprn, tension: 0.1, pointBackgroundColor: colors.cliprn },
                    { data: [0.4516, 0.4738, 0.4580, 0.4360], fill: '+1', backgroundColor: bgColors.cliprn, pointRadius: 0, borderWidth: 0, showInLegend: false },
                    { data: [0.4516, 0.4297, 0.4161, 0.4360], pointRadius: 0, borderWidth: 0, showInLegend: false },
                    // CLIP ViT-B/16
                    { label: 'CLIP ViT-B/16', data: [0.4227, 0.3814, 0.3573, 0.3538, 0.3507, 0.3544, 0.3611, 0.3760, 0.3990, 0.4262, 0.4457, 0.4659], borderColor: colors.clipvit, tension: 0.1, pointBackgroundColor: colors.clipvit },
                    { data: [0.4227, 0.4350, 0.4408, 0.4305, 0.4285, 0.4208, 0.4262, 0.4310, 0.4388, 0.4577, 0.4630, 0.4659], fill: '+1', backgroundColor: bgColors.clipvit, pointRadius: 0, borderWidth: 0, showInLegend: false },
                    { data: [0.4227, 0.3192, 0.2859, 0.2918, 0.2856, 0.2954, 0.2984, 0.3169, 0.3476, 0.3781, 0.4238, 0.4659], pointRadius: 0, borderWidth: 0, showInLegend: false },
                    // CLIP ViT-B/32
                    { label: 'CLIP ViT-B/32', data: [0.4561, 0.4184, 0.3889, 0.3655, 0.3475, 0.3345, 0.3254, 0.3193, 0.3163, 0.3159, 0.3178, 0.3203], borderColor: colors.clipvitb32, tension: 0.1, pointBackgroundColor: colors.clipvitb32 },
                    { data: [0.4561, 0.4607, 0.4665, 0.4703, 0.4617, 0.4514, 0.4337, 0.3962, 0.3724, 0.3545, 0.3363, 0.3203], fill: '+1', backgroundColor: bgColors.clipvitb32, pointRadius: 0, borderWidth: 0, showInLegend: false },
                    { data: [0.4561, 0.3788, 0.3226, 0.2912, 0.2721, 0.2718, 0.2741, 0.2795, 0.2853, 0.2961, 0.3069, 0.3203], pointRadius: 0, borderWidth: 0, showInLegend: false },
                    // ViT (Supervised)
                    { label: 'ViT B/16 (Supervised)', data: [0.4686, 0.4702, 0.4720, 0.4739, 0.4759, 0.4780, 0.4801, 0.4823, 0.4845, 0.4867, 0.4890, 0.4912], borderColor: colors.vit, tension: 0.1, pointBackgroundColor: colors.vit },
                    { data: [0.4686, 0.4747, 0.4825, 0.4871, 0.4910, 0.4940, 0.4973, 0.4993, 0.4995, 0.5005, 0.5005, 0.4912], fill: '+1', backgroundColor: bgColors.vit, pointRadius: 0, borderWidth: 0, showInLegend: false },
                    { data: [0.4686, 0.4639, 0.4627, 0.4631, 0.4630, 0.4642, 0.4658, 0.4680, 0.4716, 0.4763, 0.4822, 0.4912], pointRadius: 0, borderWidth: 0, showInLegend: false },
                    // PEv1-B16-224
                    { label: 'PEv1-B16-224', data: [0.3690, 0.4443, 0.5140, 0.5760, 0.6293, 0.6748, 0.7134, 0.7463, 0.7745, 0.7988, 0.8203, 0.8388], borderColor: colors.pe, tension: 0.1, pointBackgroundColor: colors.pe },
                    { data: [0.3690, 0.5530, 0.6768, 0.7570, 0.8097, 0.8311, 0.8387, 0.8423, 0.8446, 0.8444, 0.8422, 0.8388], fill: '+1', backgroundColor: bgColors.pe, pointRadius: 0, borderWidth: 0, showInLegend: false },
                    { data: [0.3690, 0.3763, 0.3899, 0.4083, 0.4336, 0.4669, 0.5241, 0.5990, 0.6571, 0.7112, 0.7768, 0.8388], pointRadius: 0, borderWidth: 0, showInLegend: false },
                    // SiGLip2-B-16
                    { label: 'SiGLip2-B-16', data: [0.9509, 0.9458, 0.9433, 0.9416, 0.9404, 0.9397, 0.9394, 0.9391, 0.9390, 0.9391, 0.9395, 0.9396], borderColor: colors.siglip, tension: 0.1, pointBackgroundColor: colors.siglip },
                    { data: [0.9509, 0.9671, 0.9736, 0.9748, 0.9765, 0.9770, 0.9753, 0.9716, 0.9620, 0.9554, 0.9463, 0.9396], fill: '+1', backgroundColor: bgColors.siglip, pointRadius: 0, borderWidth: 0, showInLegend: false },
                    { data: [0.9509, 0.9232, 0.9131, 0.9057, 0.9019, 0.8990, 0.9053, 0.9098, 0.9159, 0.9231, 0.9290, 0.9396], pointRadius: 0, borderWidth: 0, showInLegend: false },
                ]
            };
            new Chart(lineCtx, {
                type: 'line',
                data: lineChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Effect of Layer Combination Length on OOD Detection', font: { ...defaultFont, size: 16, weight: '600' } },
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                boxWidth: 20, 
                                font: defaultFont,
                                // This filter removes the 'undefined' labels from the legend
                                filter: (item) => item.text,
                            } 
                        },
                        annotation: {
                            annotations: {
                                // This box now correctly highlights the first data point (N=1)
                                box1: { type: 'box', xMin: -0.5, xMax: 0.5, yMin: 0.2, yMax: 1.0, backgroundColor: 'rgba(203, 213, 225, 0.3)' }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Size of Selected Layer Set (N)', font: defaultFont }, ticks: { font: defaultFont } },
                        y: { 
                            title: { display: true, text: 'Average FPR @ 95%', font: defaultFont }, 
                            min: 0.2, 
                            max: 1.0, 
                            ticks: { font: defaultFont } 
                        }
                    }
                }
            });

            const barChartData = {
                labels: ['SiGLip2', 'PEv1', 'ViT', 'CLIP RN50', 'CLIP ViT-B/16', 'CLIP ViT-B/32'],
                datasets: [
                    {
                        label: 'Best FPR',
                        data: [0.899, 0.369, 0.463, 0.416, 0.286, 0.272],
                        backgroundColor: [colors.siglip, colors.pe, colors.vit, colors.cliprn, colors.clipvit, colors.clipvitb32],
                    },
                    {
                        label: 'Baseline FPR',
                        data: [0.951, 0.369, 0.469, 0.452, 0.416, 0.4561],
                        backgroundColor: 'transparent',
                        borderColor: [colors.siglip, colors.pe, colors.vit, colors.cliprn, colors.clipvit, colors.clipvitb32],
                        borderWidth: 2,
                    }
                ]
            };
            new Chart(barCtx, {
                type: 'bar',
                data: barChartData,
                options: {
                    // The indexAxis:'y' property has been removed to make the chart vertical
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Best FPR vs. Baseline', font: { ...defaultFont, size: 16, weight: '600' } },
                        legend: { display: false }
                    },
                    // The x and y axes have been swapped for a vertical layout
                    scales: {
                        x: { 
                            grid: { display: false }, 
                            ticks: { 
                                font: defaultFont 
                            } 
                        },
                        y: { 
                            title: { display: true, text: 'FPR @ 95%', font: defaultFont }, 
                            min: 0,
                            ticks: { font: defaultFont } 
                        }
                    }
                }
            });
            
            // --- Interactive Explorer ---
            const performanceData = {
                'clip-b16': {
                    numLayers: 12,
                    baseline: { fpr: 42.27, auroc: 90.83 },
                    layerCombinations: {
                        '12': { fpr: 42.27, auroc: 90.83, datasets: { 'iNaturalist': { fpr: 30.67, auroc: 94.63 }, 'SUN': { fpr: 37.41, auroc: 92.57 }, 'Places': { fpr: 43.67, auroc: 89.96 }, 'Textures': { fpr: 57.34, auroc: 86.18 } } },
                        '0,6,8,11,12': { fpr: 30.70, auroc: 93.54, datasets: { 'iNaturalist': { fpr: 15.98, auroc: 96.90 }, 'SUN': { fpr: 45.58, auroc: 89.69 }, 'Places': { fpr: 35.71, auroc: 92.72 }, 'Textures': { fpr: 25.51, auroc: 94.84 } } },
                        '6,8,11,12': { fpr: 32.15, auroc: 92.80, datasets: { 'iNaturalist': { fpr: 18.20, auroc: 96.20 }, 'SUN': { fpr: 42.10, auroc: 90.80 }, 'Places': { fpr: 37.50, auroc: 91.90 }, 'Textures': { fpr: 30.80, auroc: 92.30 } } }
                    }
                },
                'clip-b32': {
                    numLayers: 12,
                    baseline: { fpr: 45.61, auroc: 89.87 },
                    layerCombinations: {
                        '12': { fpr: 45.61, auroc: 89.87, datasets: { 'iNaturalist': { fpr: 33.85, auroc: 93.62 }, 'SUN': { fpr: 40.99, auroc: 91.56 }, 'Places': { fpr: 46.71, auroc: 89.25 }, 'Textures': { fpr: 60.90, auroc: 85.03 } } },
                        '0,4,6,8,11,12': { fpr: 29.01, auroc: 93.42, datasets: { 'iNaturalist': { fpr: 12.02, auroc: 97.64 }, 'SUN': { fpr: 28.98, auroc: 93.37 }, 'Places': { fpr: 35.69, auroc: 91.61 }, 'Textures': { fpr: 39.36, auroc: 91.07 } } },
                        '4,6,8,12': { fpr: 35.20, auroc: 91.50, datasets: { 'iNaturalist': { fpr: 20.50, auroc: 95.80 }, 'SUN': { fpr: 35.40, auroc: 92.10 }, 'Places': { fpr: 40.20, auroc: 90.50 }, 'Textures': { fpr: 44.70, auroc: 87.60 } } }
                    }
                },
                'clip-l14': {
                    numLayers: 24,
                    baseline: { fpr: 38.50, auroc: 92.10 },
                    layerCombinations: {
                        '24': { fpr: 38.50, auroc: 92.10, datasets: { 'iNaturalist': { fpr: 28.30, auroc: 95.20 }, 'SUN': { fpr: 35.20, auroc: 93.40 }, 'Places': { fpr: 41.80, auroc: 90.80 }, 'Textures': { fpr: 48.70, auroc: 88.00 } } },
                        '6,12,18,20,22,24': { fpr: 32.40, auroc: 93.80, datasets: { 'iNaturalist': { fpr: 18.90, auroc: 96.70 }, 'SUN': { fpr: 30.50, auroc: 94.20 }, 'Places': { fpr: 37.20, auroc: 92.40 }, 'Textures': { fpr: 43.00, auroc: 91.90 } } }
                    }
                },
                'resnet': {
                    numLayers: 16,
                    baseline: { fpr: 45.16, auroc: 89.95 },
                    layerCombinations: {
                        '16': { fpr: 45.16, auroc: 89.95, datasets: { 'iNaturalist': { fpr: 44.00, auroc: 91.59 }, 'SUN': { fpr: 35.13, auroc: 92.83 }, 'Places': { fpr: 44.30, auroc: 89.38 }, 'Textures': { fpr: 57.22, auroc: 85.99 } } },
                        '8,12,14,16': { fpr: 41.61, auroc: 90.80, datasets: { 'iNaturalist': { fpr: 41.79, auroc: 92.00 }, 'SUN': { fpr: 31.83, auroc: 93.48 }, 'Places': { fpr: 40.46, auroc: 90.36 }, 'Textures': { fpr: 52.38, auroc: 87.37 } } }
                    }
                }
            };

            let currentArch = 'clip-b16';
            let selectedLayers = [];
            
            const archSelect = document.getElementById('architecture');
            const calculateBtn = document.getElementById('calculate-btn');
            const resetBtn = document.getElementById('reset-btn');
            const svg = document.getElementById('interactive-diagram');
            const diagramContainer = document.getElementById('diagram-content-container');

            function initializeControls() {
                const numLayers = performanceData[currentArch].numLayers;
                const checkboxContainer = document.getElementById('layer-checkboxes');
                checkboxContainer.innerHTML = '';
                selectedLayers = [];
                
                for (let i = 1; i <= numLayers; i++) {
                    const label = document.createElement('label');
                    label.className = 'flex items-center justify-center p-2 text-sm border-2 border-slate-300 rounded-md cursor-pointer transition-colors duration-200 select-none';
                    label.innerHTML = `<input type="checkbox" value="${i}" class="hidden"><span class="font-medium">${i}</span>`;
                    label.addEventListener('click', (e) => { e.preventDefault(); toggleLayer(i, label); });
                    checkboxContainer.appendChild(label);
                }
                
                renderDiagram(numLayers);
                document.getElementById('results-container').style.display = 'none';
            }

            function renderDiagram(numLayers) {
                const V_SPACING = 70;
                const LAYER_BOX_H = 40;
                const START_Y = 120;
                const TOTAL_HEIGHT = START_Y + (numLayers * V_SPACING) + 120;

                svg.setAttribute('viewBox', `0 0 800 ${TOTAL_HEIGHT}`);
                let content = '';

                // Static elements
                    content += `
                    <rect x="230" y="80" width="550" height="${START_Y - 100 + (numLayers * V_SPACING)}" rx="10" class="svg-bg" />
                    <rect x="230" y="${START_Y - 20 + (numLayers * V_SPACING) + 40}" width="550" height="70" rx="10" class="svg-bg" />
                    <text x="505" y="105" text-anchor="middle" class="svg-text-label">Visual Encoders</text>
                    <text x="505" y="${START_Y - 20 + (numLayers * V_SPACING) + 70}" text-anchor="middle" class="svg-text-label">Final Fused Score</text>
                    <rect x="10" y="${TOTAL_HEIGHT/2 - 40}" width="130" height="80" rx="5" fill="#eef2ff" stroke="#a5b4fc" stroke-width="2"/>
                    <text x="75" y="${TOTAL_HEIGHT/2 - 15}" text-anchor="middle" class="svg-text-label">ID Images</text>
                    <text x="75" y="${TOTAL_HEIGHT/2 + 15}" text-anchor="middle" font-size="30">🖼️</text>
                    <rect x="160" y="10" width="200" height="40" rx="20" fill="#fff7ed" stroke="#fed7aa" stroke-width="2"/>
                    <text x="260" y="35" text-anchor="middle" class="svg-text-label">ID Labels</text>
                    <rect x="420" y="10" width="160" height="40" rx="5" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="2"/>
                    <text x="500" y="35" text-anchor="middle" class="svg-text-label">Text Encoder</text>
                `;

                // Main bus lines
                const imageBusX = 260;
                const firstLayerCenterY = START_Y + LAYER_BOX_H / 2;
                const lastLayerCenterY = START_Y + (numLayers - 1) * V_SPACING + LAYER_BOX_H / 2;
                content += `<path class="svg-arrow-path" d="M140 ${TOTAL_HEIGHT/2} H ${imageBusX}"/>`;
                content += `<path class="svg-arrow-path" d="M${imageBusX} ${firstLayerCenterY} V ${lastLayerCenterY}"/>`;

                // Dynamic layers
                for (let i = 1; i <= numLayers; i++) {
                    const layerY = START_Y + (i - 1) * V_SPACING;
                    const center_y = layerY + LAYER_BOX_H / 2;
                    
                    // Layer group
                    content += `<g id="svg-layer-group-${i}" class="svg-layer-group">`;
                    // Connections
                    content += `<path class="svg-arrow-path" marker-end="url(#arrowhead)" d="M${imageBusX} ${center_y} H 300"/>`; // From Img Bus
                    if (i > 1) { // Inter-layer
                        const prev_center_y = center_y - V_SPACING;
                        content += `<path class="svg-arrow-path" marker-end="url(#arrowhead)" d="M375 ${prev_center_y + LAYER_BOX_H/2} Q 350 ${prev_center_y + LAYER_BOX_H/2 + V_SPACING/2}, 375 ${center_y - LAYER_BOX_H/2}" />`;
                    }
                    content += `<path class="svg-arrow-path svg-output-arrow" marker-end="url(#arrowhead)" d="M450 ${center_y} H 650"/>`; // To Score
                    content += `<path class="svg-arrow-path" marker-end="url(#arrowhead)" d="M500 50 V 100 C 500 110, 580 110, 580 ${center_y - 10} H 640"/>`; // From Text Encoder

                    // Layer and Score elements
                    content += `<polygon class="svg-layer-box" points="300,${layerY} 450,${layerY} 450,${layerY + LAYER_BOX_H} 300,${layerY + LAYER_BOX_H}"/>
                                <text x="375" y="${center_y + 5}" text-anchor="middle" class="svg-layer-text">Layer ${i}</text>
                                <g class="svg-score-group">
                                    <text x="660" y="${center_y + 6}" font-size="20" class="font-bold">⊕</text>
                                    <text x="715" y="${center_y + 5}" text-anchor="middle" class="svg-text-small">Scores ${i}</text>
                                </g>`;
                    content += `</g>`;
                }
                
                // Final Score Connection
                const lastLayerY = START_Y + (numLayers - 1) * V_SPACING;
                const finalScoreY = lastLayerY + V_SPACING + 65;
                content += `
                    <path class="svg-arrow-path" marker-end="url(#arrowhead)" d="M375 ${lastLayerY + LAYER_BOX_H} V ${finalScoreY}"/>
                    <text x="505" y="${finalScoreY + 8}" font-size="24" fill="#1e293b" class="font-bold">⊕</text>
                `;

                diagramContainer.innerHTML = content;
                updateDiagramHighlights();
            }

            function toggleLayer(layer, labelElement) {
                const index = selectedLayers.indexOf(layer);
                if (index > -1) {
                    selectedLayers.splice(index, 1);
                    labelElement.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                } else {
                    selectedLayers.push(layer);
                    labelElement.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                }
                selectedLayers.sort((a, b) => a - b);
                updateDiagramHighlights();
            }
            
            function updateDiagramHighlights() {
                const numLayers = performanceData[currentArch].numLayers;
                for(let i=1; i <= numLayers; i++) {
                    const group = document.getElementById(`svg-layer-group-${i}`);
                    if(group) {
                       group.classList.toggle('highlighted', selectedLayers.includes(i));
                    }
                }
            }

            function getClosestCombination(layers) { if (layers.length === 0) return null; const lastLayer = performanceData[currentArch].numLayers; let key = layers.join(','); if (layers.length === 1 && layers[0] === lastLayer) key = String(lastLayer); const combinations = performanceData[currentArch].layerCombinations; if (combinations[key]) return combinations[key]; let closest = null; let minDiff = Infinity; for (const combKey in combinations) { const combLayers = combKey.split(',').map(Number); const sizeDiff = Math.abs(combLayers.length - layers.length); const overlap = combLayers.filter(l => layers.includes(l)).length; const diff = sizeDiff * 2 - overlap; if (diff < minDiff) { minDiff = diff; closest = combinations[combKey]; } } return closest; }
            function calculatePerformance() { if (selectedLayers.length === 0) { document.getElementById('message-box').textContent = 'Please select at least one layer.'; setTimeout(()=>document.getElementById('message-box').textContent='', 3000); return; } const metrics = getClosestCombination(selectedLayers); if (!metrics) { document.getElementById('message-box').textContent = 'No matching data for this combination.'; setTimeout(()=>document.getElementById('message-box').textContent='', 3000); return; } const resultsContainer = document.getElementById('results-container'); resultsContainer.style.display = 'block'; resultsContainer.classList.add('fade-in'); const baseline = performanceData[currentArch].baseline; updateMetricCard('fpr', metrics.fpr, baseline.fpr, false); updateMetricCard('auroc', metrics.auroc, baseline.auroc, true); document.getElementById('layers-count').textContent = selectedLayers.length; document.getElementById('selected-layers').textContent = selectedLayers.map(l => `L${l}`).join(', '); updateDatasetTable(metrics.datasets); resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
            function updateMetricCard(type, value, baselineValue, higherIsBetter) { const valueEl = document.getElementById(`${type}-value`); const changeEl = document.getElementById(`${type}-change`); valueEl.textContent = value.toFixed(2) + '%'; const diff = value - baselineValue; const isImprovement = higherIsBetter ? diff > 0 : diff < 0; changeEl.className = 'text-sm font-medium rounded-full px-3 py-1 inline-block'; if (Math.abs(diff) < 0.01) { changeEl.textContent = 'Baseline'; changeEl.classList.add('bg-slate-100', 'text-slate-800'); } else if (isImprovement) { changeEl.textContent = `${higherIsBetter ? '↑' : '↓'} ${Math.abs(diff).toFixed(2)}% improvement`; changeEl.classList.add('bg-green-100', 'text-green-800'); } else { changeEl.textContent = `${higherIsBetter ? '↓' : '↑'} ${Math.abs(diff).toFixed(2)}% worse`; changeEl.classList.add('bg-red-100', 'text-red-800'); } }
            function updateDatasetTable(datasets) { const tbody = document.getElementById('dataset-tbody'); tbody.innerHTML = ''; for (const [dataset, metrics] of Object.entries(datasets)) { const row = document.createElement('tr'); row.innerHTML = ` <td class="p-3 text-sm text-slate-700">${dataset}</td> <td class="p-3 text-sm text-slate-700">${metrics.fpr.toFixed(2)}%</td> <td class="p-3 text-sm text-slate-700">${metrics.auroc.toFixed(2)}%</td> `; tbody.appendChild(row); } }


            archSelect.addEventListener('change', (e) => {
                currentArch = e.target.value;
                initializeControls();
            });
            calculateBtn.addEventListener('click', calculatePerformance);
            resetBtn.addEventListener('click', initializeControls);
            
            // Initial render
            initializeControls();
        });
    </script>
</body>
</html>